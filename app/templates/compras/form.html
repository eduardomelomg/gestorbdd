{% extends "base.html" %}
{% block title %}Nova Compra{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-3 gap-2">
  <a href="{{ url_for('compras.listar') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
  <h4 class="fw-bold mb-0">Registrar Compra de Insumo</h4>
</div>
<div class="card shadow-sm" style="max-width:500px">
  <div class="card-body">
    <form method="POST" onsubmit="return confirm('Deseja registrar esta compra?')">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="mb-3"><label class="form-label">Insumo *</label>
        <select name="insumo_id" class="form-select" required>
          {% for i in insumos %}<option value="{{ i.id }}">{{ i.nome }} ({{ i.unidade }})</option>{% endfor %}
        </select></div>
      <div class="mb-3"><label class="form-label">Data da Compra *</label>
        <input type="date" name="data_compra" class="form-control" required value="{{ today }}"></div>
      <div class="mb-3"><label class="form-label">Fornecedor</label>
        <input type="text" name="fornecedor" class="form-control"></div>
      <div class="row g-3 mb-3">
        <div class="col"><label class="form-label">Qtd Embalagens</label>
          <input type="number" step="1" id="qty_packs" class="form-control" placeholder="Ex: 2 potes" oninput="calcTotal()"></div>
        <div class="col"><label class="form-label">Conteúdo/Emb.</label>
          <input type="number" step="0.01" id="weight_pack" class="form-control" placeholder="Ex: 500" oninput="calcTotal()"></div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col"><label class="form-label">Total para Estoque</label>
          <input type="number" step="0.01" name="quantidade_comprada" id="total_qty" class="form-control" required></div>
        <div class="col"><label class="form-label">Custo Total (R$)</label>
          <input type="number" step="0.01" name="custo_total" class="form-control" required></div>
      </div>
      <script>
        function calcTotal() {
          const qty = parseFloat(document.getElementById('qty_packs').value) || 0;
          const weight = parseFloat(document.getElementById('weight_pack').value) || 0;
          document.getElementById('total_qty').value = (qty * weight).toFixed(2);
        }
      </script>
      <div class="mb-3"><label class="form-label">Observações</label>
        <textarea name="observacoes" class="form-control" rows="2"></textarea></div>
      <button type="submit" class="btn btn-warning">Registrar e Atualizar Estoque</button>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  const d = new Date().toISOString().split('T')[0];
  document.querySelector('input[name="data_compra"]').value = d;
</script>
{% endblock %}
