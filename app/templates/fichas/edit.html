{% extends "base.html" %}
{% block title %}Ficha Técnica — {{ produto.nome }}{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-3 gap-2">
  <a href="{{ url_for('fichas.listar') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
  <h4 class="fw-bold mb-0">Ficha Técnica — {{ produto.nome }}</h4>
</div>
<div class="row g-3">
  <!-- Header edit -->
  <div class="col-md-5">
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-bold">Parâmetros</div>
      <div class="card-body">
        <form method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="save_header">
          <div class="mb-2"><label class="form-label small">Rendimento (unidades)</label>
            <input type="number" step="0.01" name="rendimento_unidades" class="form-control form-control-sm" value="{{ ficha.rendimento_unidades }}" required></div>
          <div class="mb-2"><label class="form-label small">Mão de Obra Total (R$)</label>
            <input type="number" step="0.01" name="mao_de_obra_total" class="form-control form-control-sm" value="{{ ficha.mao_de_obra_total }}"></div>
          <div class="mb-2"><label class="form-label small">Perdas (%)</label>
            <input type="number" step="0.01" name="perdas_percentual" class="form-control form-control-sm" value="{{ ficha.perdas_percentual }}"></div>
          <div class="mb-3"><label class="form-label small">Margem Desejada (%)</label>
            <input type="number" step="0.01" name="margem_desejada_percentual" class="form-control form-control-sm" value="{{ ficha.margem_desejada_percentual }}"></div>
          <button type="submit" class="btn btn-sm btn-warning w-100">Salvar Parâmetros</button>
        </form>
      </div>
    </div>

    <!-- Resultado / Simulador -->
    <div class="card shadow-sm border-success mb-3">
      <div class="card-header bg-success text-white fw-bold d-flex justify-content-between">
        Inteligência de Preço
        <span class="badge bg-light text-success">Simulador</span>
      </div>
      <div class="card-body">
        <!-- Parte 1: Custos -->
        <h6 class="fw-bold border-bottom pb-1 small text-muted">Estrutura de Custos</h6>
        <div class="d-flex justify-content-between mb-1 small">
          <span>Insumos/Emb.</span>
          <span>{{ resumo.custo_total_insumos | brl }}</span>
        </div>
        <div class="d-flex justify-content-between mb-1 small text-danger">
          <span>Perdas ({{ ficha.perdas_percentual | qty }}%)</span>
          <span>+ {{ (resumo.custo_total_receita - resumo.custo_total_insumos - ficha.mao_de_obra_total) | brl }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2 small text-primary">
          <span>Mão de Obra</span>
          <span>+ {{ ficha.mao_de_obra_total | brl }}</span>
        </div>
        <div class="d-flex justify-content-between fw-bold border-top pt-1 text-dark">
          <span>Custo Unitário</span>
          <span>{{ resumo.custo_unitario | brl }}</span>
        </div>

        <!-- Parte 2: Sugestão vs Atual -->
        <h6 class="fw-bold border-bottom pb-1 mt-3 small text-muted">Simulação de Venda</h6>
        <div class="row g-2 mt-1">
          <div class="col-6">
            <div class="p-2 border rounded bg-light">
              <div class="text-muted" style="font-size: 0.7rem;">Sugerido ({{ ficha.margem_desejada_percentual | qty }}% margem)</div>
              <div class="fw-bold text-success">{{ resumo.preco_sugerido | brl }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="p-2 border rounded bg-primary-subtle border-primary">
              <div class="text-primary text-uppercase fw-bold" style="font-size: 0.6rem;">Preço no Cadastro</div>
              <div class="fw-bold text-primary">{{ resumo.preco_venda_atual | brl }}</div>
            </div>
          </div>
        </div>

        <!-- Parte 3: Indicadores Reais -->
        <div class="mt-3 p-2 bg-dark text-white rounded shadow-inner">
          <div class="d-flex justify-content-between small opacity-75">
            <span>Lucro Líquido Real</span>
            <span class="fw-bold text-success">+ {{ resumo.lucro_unitario_atual | brl }}</span>
          </div>
          <div class="d-flex justify-content-between small mb-1 opacity-75">
            <span>Margem Real (B2C)</span>
            <span class="fw-bold {{ 'text-success' if resumo.margem_atual_percentual >= 50 else 'text-warning' }}">{{ resumo.margem_atual_percentual | qty }}%</span>
          </div>
          <div class="d-flex justify-content-between small border-top border-secondary pt-1 mt-1">
            <span>Fator de Markup</span>
            <span class="badge bg-warning text-dark">{{ resumo.markup_atual | qty }}x</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Items -->
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header fw-bold">Ingredientes / Embalagens</div>
      <table class="table table-sm mb-0">
        <thead class="table-light"><tr><th>Insumo</th><th>Qtd/Receita</th><th>Custo Item</th><th>Tipo</th><th></th></tr></thead>
        <tbody>
        {% for item in ficha.itens %}
        <tr>
          <td>{{ item.insumo.nome }}</td>
          <td>{{ item.quantidade_por_receita | qty_smart(item.insumo.unidade) }}</td>
          <td>{{ item.custo_item | brl }}</td>
          <td><span class="badge bg-secondary">{{ item.tipo_item }}</span></td>
          <td>
            <form method="POST">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="remove_item">
              <input type="hidden" name="item_id" value="{{ item.id }}">
              <button class="btn btn-sm btn-outline-danger py-0">✕</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center text-muted">Nenhum item. Adicione abaixo.</td></tr>
        {% endfor %}
        </tbody>
      </table>
      <!-- Add item form -->
      <div class="card-footer">
        <form method="POST" class="row g-2 align-items-end">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="add_item">
          <div class="col-md-3"><label class="form-label small">Insumo</label>
            <select name="insumo_id" class="form-select form-select-sm" required>
              {% for i in insumos %}<option value="{{ i.id }}">{{ i.nome }} ({{ i.unidade }})</option>{% endfor %}
            </select></div>
          <div class="col-md-2"><label class="form-label small">Qtd</label>
            <input type="number" step="0.0001" name="quantidade_por_receita" class="form-control form-control-sm" required></div>
          <div class="col-md-3"><label class="form-label small">Unidade</label>
            <select name="unidade_entrada" class="form-select form-select-sm">
              <option value="base">Gramas/ML/Un</option>
              <option value="packs">Caixas/Pacotes/Emb.</option>
            </select></div>
          <div class="col-md-2"><label class="form-label small">Tipo</label>
            <select name="tipo_item" class="form-select form-select-sm">
              <option>Insumo</option><option>Embalagem</option>
            </select></div>
          <div class="col-md-2"><button type="submit" class="btn btn-sm btn-success w-100">+ Add</button></div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
