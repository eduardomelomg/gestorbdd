{% extends "base.html" %}
{% block title %}Ficha Técnica — {{ produto.nome }}{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-3 gap-2">
  <a href="{{ url_for('fichas.listar') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
  <h4 class="fw-bold mb-0">Ficha Técnica — {{ produto.nome }}</h4>
</div>
<div class="row g-3">
  <!-- Header edit -->
  <div class="col-md-5">
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-bold">Parâmetros</div>
      <div class="card-body">
        <form method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="save_header">
          <div class="mb-2"><label class="form-label small">Rendimento (unidades)</label>
            <input type="number" step="0.01" name="rendimento_unidades" class="form-control form-control-sm" value="{{ ficha.rendimento_unidades }}" required></div>
          <div class="mb-2"><label class="form-label small">Mão de Obra Total (R$)</label>
            <input type="number" step="0.01" name="mao_de_obra_total" class="form-control form-control-sm" value="{{ ficha.mao_de_obra_total }}"></div>
          <div class="mb-2"><label class="form-label small">Perdas (%)</label>
            <input type="number" step="0.01" name="perdas_percentual" class="form-control form-control-sm" value="{{ ficha.perdas_percentual }}"></div>
          <div class="mb-3"><label class="form-label small">Margem Desejada (%)</label>
            <input type="number" step="0.01" name="margem_desejada_percentual" class="form-control form-control-sm" value="{{ ficha.margem_desejada_percentual }}"></div>
          <button type="submit" class="btn btn-sm btn-warning w-100">Salvar Parâmetros</button>
        </form>
      </div>
    </div>

    <!-- Resultado / Simulador -->
    <div class="card shadow-sm border-success mb-3">
      <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-graph-up-arrow"></i> Inteligência de Preço</span>
        <span class="badge bg-light text-success">Real-time</span>
      </div>
      <div class="card-body">
        <!-- Parte 1: Custos -->
        <h6 class="fw-bold border-bottom pb-1 small text-muted">Custo Unitário Final: <span class="text-dark">{{ resumo.custo_unitario | brl }}</span></h6>
        
        <div class="row g-2 mt-2">
          <!-- Varejo -->
          <div class="col-6">
            <div class="p-2 border rounded bg-primary-subtle border-primary h-100">
              <div class="text-primary text-uppercase fw-bold" style="font-size: 0.65rem;">Varejo (B2C)</div>
              <div class="fw-bold text-primary fs-5">{{ resumo.preco_venda_atual | brl }}</div>
              <div class="mt-2 small">
                <div class="d-flex justify-content-between border-bottom border-primary border-opacity-25 pb-1">
                  <span class="opacity-75">Lucro:</span>
                  <span class="fw-bold">+{{ resumo.lucro_unitario_atual | brl }}</span>
                </div>
                <div class="d-flex justify-content-between pt-1">
                  <span class="opacity-75">Margem:</span>
                  <span class="fw-bold">{{ resumo.margem_atual_percentual | qty }}%</span>
                </div>
              </div>
              <div class="mt-2 text-center"><span class="badge bg-primary">Markup {{ resumo.markup_atual | qty }}x</span></div>
            </div>
          </div>
          <!-- Atacado -->
          <div class="col-6">
            <div class="p-2 border rounded bg-secondary-subtle border-secondary h-100">
              <div class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Atacado (B2B)</div>
              <div class="fw-bold text-secondary fs-5">{{ resumo.preco_venda_atacado | brl }}</div>
              <div class="mt-2 small">
                <div class="d-flex justify-content-between border-bottom border-secondary border-opacity-25 pb-1">
                  <span class="opacity-75">Lucro:</span>
                  <span class="fw-bold">+{{ resumo.lucro_unitario_atacado | brl }}</span>
                </div>
                <div class="d-flex justify-content-between pt-1">
                  <span class="opacity-75">Margem:</span>
                  <span class="fw-bold">{{ resumo.margem_atacado_percentual | qty }}%</span>
                </div>
              </div>
              <div class="mt-2 text-center"><span class="badge bg-secondary">Markup {{ resumo.markup_atacado | qty }}x</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simulador de Encomendas -->
    <div class="card shadow-sm border-warning">
      <div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-calculator"></i> Simulador de Encomendas</div>
      <div class="card-body p-3">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label small fw-bold">Qtd Unidades</label>
            <input type="number" id="sim_qtd" class="form-control form-control-sm border-warning" value="50" oninput="runSimulation()">
          </div>
          <div class="col-6">
            <label class="form-label small fw-bold">Preço Unit. (R$)</label>
            <input type="number" id="sim_preco" class="form-control form-control-sm border-warning" value="{{ (resumo.preco_venda_atacado|float) if (resumo.preco_venda_atacado|float) > 0 else 7.0 }}" oninput="runSimulation()">
          </div>
        </div>
        
        <div class="bg-light rounded p-2 border border-warning border-opacity-50">
          <div class="d-flex justify-content-between mb-1 small text-muted">
            <span>Custo Total:</span>
            <span id="res_custo" class="fw-bold text-danger">R$ 0,00</span>
          </div>
          <div class="d-flex justify-content-between mb-1 small text-muted">
            <span>Receita Total:</span>
            <span id="res_receita" class="fw-bold text-primary">R$ 0,00</span>
          </div>
          <div class="d-flex justify-content-between fw-bold border-top pt-1 text-dark">
            <span>Lucro Líquido:</span>
            <span id="res_lucro" class="text-success fs-5">R$ 0,00</span>
          </div>
          <div class="mt-2 text-center"><span id="res_margem" class="badge bg-dark px-3 mt-1">Margem Real: 0%</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Items -->
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header fw-bold">Ingredientes / Embalagens</div>
      <table class="table table-sm mb-0">
        <thead class="table-light"><tr><th>Insumo</th><th>Qtd/Receita</th><th>Custo Item</th><th>Tipo</th><th></th></tr></thead>
        <tbody>
        {% for item in ficha.itens %}
        <tr>
          <td>{{ item.insumo.nome }}</td>
          <td>{{ item.quantidade_por_receita | qty_smart(item.insumo.unidade) }}</td>
          <td>{{ item.custo_item | brl }}</td>
          <td><span class="badge bg-secondary">{{ item.tipo_item }}</span></td>
          <td>
            <form method="POST">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="remove_item">
              <input type="hidden" name="item_id" value="{{ item.id }}">
              <button class="btn btn-sm btn-outline-danger py-0">✕</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center text-muted">Nenhum item. Adicione abaixo.</td></tr>
        {% endfor %}
        </tbody>
      </table>
      <!-- Add item form -->
      <div class="card-footer">
        <form method="POST" class="row g-2 align-items-end">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="add_item">
          <div class="col-md-3"><label class="form-label small">Insumo</label>
            <select name="insumo_id" class="form-select form-select-sm" required>
              {% for i in insumos %}<option value="{{ i.id }}">{{ i.nome }} ({{ i.unidade }})</option>{% endfor %}
            </select></div>
          <div class="col-md-2"><label class="form-label small">Qtd</label>
            <input type="number" step="0.0001" name="quantidade_por_receita" class="form-control form-control-sm" required></div>
          <div class="col-md-3"><label class="form-label small">Unidade</label>
            <select name="unidade_entrada" class="form-select form-select-sm">
              <option value="base">Gramas/ML/Un</option>
              <option value="packs">Caixas/Pacotes/Emb.</option>
            </select></div>
          <div class="col-md-2"><label class="form-label small">Tipo</label>
            <select name="tipo_item" class="form-select form-select-sm">
              <option>Insumo</option><option>Embalagem</option>
            </select></div>
          <div class="col-md-2"><button type="submit" class="btn btn-sm btn-success w-100">+ Add</button></div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
  <script>
    function runSimulation() {
      const custoUnit = {{ resumo.custo_unitario | float }};
      const qtd = parseFloat(document.getElementById('sim_qtd').value) || 0;
      const preco = parseFloat(document.getElementById('sim_preco').value) || 0;
      
      const custoTotal = custoUnit * qtd;
      const receitaTotal = preco * qtd;
      const lucroTotal = receitaTotal - custoTotal;
      const margem = receitaTotal > 0 ? (lucroTotal / receitaTotal) * 100 : 0;
      
      const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      
      document.getElementById('res_custo').innerText = fmt(custoTotal);
      document.getElementById('res_receita').innerText = fmt(receitaTotal);
      document.getElementById('res_lucro').innerText = fmt(lucroTotal);
      document.getElementById('res_margem').innerText = `Margem Real: ${margem.toFixed(1).replace('.', ',')}%`;
      
      // Toggle badge color based on margin
      const badge = document.getElementById('res_margem');
      badge.className = 'badge px-3 mt-1 ' + (margem >= 50 ? 'bg-success' : (margem >= 30 ? 'bg-warning text-dark' : 'bg-danger'));
    }
    document.addEventListener('DOMContentLoaded', runSimulation);
  </script>
{% endblock %}
