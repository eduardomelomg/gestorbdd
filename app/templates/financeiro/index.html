{% extends "base.html" %}
{% block title %}Financeiro{% endblock %}
{% block content %}
<!-- Month Selector -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold mb-0"><i class="bi bi-currency-dollar"></i> Financeiro</h4>
  <form class="d-flex gap-2 align-items-center" method="GET">
    <select name="mes" class="form-select form-select-sm" style="width:auto">
      {% for m in range(1,13) %}<option value="{{ m }}" {{ "selected" if m == mes }}>{{ m | mes_extenso }}</option>{% endfor %}
    </select>
    <input type="number" name="ano" class="form-control form-control-sm" style="width:90px" value="{{ ano }}">
    <button class="btn btn-outline-secondary btn-sm">Ver</button>
  </form>
</div>

<!-- KPI row -->
<div class="row g-3 mb-4">
  {% set kpi_data = [
    ("ðŸ’° Recebido", kpis.recebido_mes, "success", "kpi-green"),
    ("ðŸ“ˆ Faturamento Realizado", kpis.faturamento_realizado, "primary", "kpi-blue"),
    ("ðŸ† Lucro Realizado", kpis.lucro_realizado, "success" if kpis.lucro_realizado >= 0 else "danger", "kpi-green"),
    ("â³ A Receber", kpis.a_receber, "warning", "kpi-orange"),
    ("ðŸ’¸ Despesas", kpis.despesas_mes, "danger", "kpi-red"),
    ("ðŸ“Š Resultado Caixa", kpis.resultado_mes, "success" if kpis.resultado_mes >= 0 else "danger", "kpi-blue"),
  ] %}
  {% for label, val, color, kpi_class in kpi_data %}
  <div class="col-md-4 col-6">
    <div class="card kpi-card {{ kpi_class }} shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small">{{ label }}</div>
        <div class="fs-4 fw-bold text-{{ color }}">{{ val | brl }}</div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="row g-3">
  <!-- Recebimentos -->
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header fw-bold">Ãšltimos Recebimentos</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light"><tr><th>Data</th><th>Pedido</th><th>Forma</th><th>Valor</th></tr></thead>
          <tbody>
          {% for p in pagamentos %}
          <tr>
            <td>{{ p.data_recebimento.strftime('%d/%m/%Y') }}</td>
            <td><a href="{{ url_for('pedidos.detalhe', pedido_id=p.pedido_id) }}">{{ p.pedido.numero_pedido }}</a></td>
            <td>{{ p.forma_pagamento }}</td>
            <td>{{ p.valor_recebido | brl }}</td>
          </tr>
          {% else %}<tr><td colspan="4" class="text-center text-muted">Nenhum recebimento.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Despesas -->
  <div class="col-md-5">
    <div class="card shadow-sm">
      <div class="card-header fw-bold d-flex justify-content-between">
        Despesas do mÃªs
        <a href="{{ url_for('financeiro.nova_despesa') }}" class="btn btn-sm btn-danger">+ Despesa</a>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light"><tr><th>Data</th><th>Categoria</th><th>Valor</th><th></th></tr></thead>
          <tbody>
          {% for d in despesas %}
          <tr>
            <td>{{ d.data.strftime('%d/%m') }}</td>
            <td>{{ d.categoria }}</td>
            <td>{{ d.valor | brl }}</td>
            <td>{% if current_user.is_admin %}
              <form method="POST" action="{{ url_for('financeiro.deletar_despesa', despesa_id=d.id) }}" onsubmit="return confirm('Deseja realmente remover esta despesa?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-outline-danger py-0" title="Remover"><i class="bi bi-trash"></i></button>
              </form>
              {% endif %}</td>
          </tr>
          {% else %}<tr><td colspan="4" class="text-center text-muted">Sem despesas neste mÃªs.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
