{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-3 gap-2">
  <a href="{{ url_for('pedidos.listar') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
  <h4 class="fw-bold mb-0">Novo Pedido</h4>
</div>
<div class="card shadow-sm">
  <div class="card-body">
    <form method="POST" id="formPedido">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Cliente *</label>
          <select name="cliente_id" class="form-select" required>
            {% for c in clientes %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Canal</label>
          <select name="canal" class="form-select">
            <option>B2C</option><option>B2B</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data/Hora Agendada</label>
          <input type="datetime-local" name="data_hora_agendada" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de Entrega</label>
          <select name="tipo_entrega" class="form-select" id="tipoEntrega">
            <option>Retirada</option><option>Entrega</option>
          </select>
        </div>
        <div class="col-md-6" id="enderecoDiv" style="display:none">
          <label class="form-label">Endereço de Entrega</label>
          <input type="text" name="endereco_entrega" class="form-control" placeholder="Rua, número, bairro...">
        </div>
        <div class="col-md-2">
          <label class="form-label">Desconto (R$)</label>
          <input type="number" step="0.01" name="desconto" class="form-control" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">Taxa Entrega (R$)</label>
          <input type="number" step="0.01" name="taxa_entrega" class="form-control" value="0">
        </div>
        <div class="col-md-4">
          <label class="form-label">Observações</label>
          <input type="text" name="observacoes" class="form-control">
        </div>
      </div>

      <h6 class="fw-bold">Itens</h6>
      <table class="table table-sm" id="itensTable">
        <thead class="table-light">
          <tr><th>Produto</th><th>Qtd</th><th>Preço Unit. (R$)</th><th></th></tr>
        </thead>
        <tbody id="itensBody">
          <tr>
            <td><select name="produto_id[]" class="form-select form-select-sm" required>
              {% for p in produtos %}<option value="{{ p.id }}" data-varejo="{{ p.preco_varejo }}">{{ p.nome }}</option>{% endfor %}
            </select></td>
            <td><input type="number" step="0.01" name="quantidade[]" class="form-control form-control-sm" value="1" min="0.01" required></td>
            <td><input type="number" step="0.01" name="preco_unitario[]" class="form-control form-control-sm" required></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">✕</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addItem()"><i class="bi bi-plus-lg"></i> Adicionar Item</button>

      <div class="d-flex gap-2 mt-2">
        <button type="submit" class="btn btn-warning fw-bold">Criar Pedido</button>
        <a href="{{ url_for('pedidos.listar') }}" class="btn btn-outline-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
{% set prod_list = [] %}
{% for p in produtos %}
  {% do prod_list.append({'id': p.id, 'nome': p.nome, 'preco_varejo': p.preco_varejo|float}) %}
{% endfor %}
const produtos = {{ prod_list | tojson }};
function addItem() {
  const tbody = document.getElementById('itensBody');
  const row = tbody.rows[0].cloneNode(true);
  row.querySelectorAll('input').forEach(i => i.value = i.defaultValue || '');
  tbody.appendChild(row);
}
function removeRow(btn) {
  const tbody = document.getElementById('itensBody');
  if (tbody.rows.length > 1) btn.closest('tr').remove();
}
document.getElementById('tipoEntrega').addEventListener('change', function() {
  document.getElementById('enderecoDiv').style.display = this.value === 'Entrega' ? 'block' : 'none';
});
</script>
{% endblock %}
